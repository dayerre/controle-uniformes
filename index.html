<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Uniformes</title>
  <style>
    :root{
      /* Light theme */
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel2:#f9fafb;
      --text:#111827;
      --muted:#6b7280;
      --line:rgba(17,24,39,.12);
      --line2:rgba(17,24,39,.08);
      --shadow:0 12px 28px rgba(17,24,39,.10);
      --radius:14px;
      --primary:#111827; /* black-ish */
      --primary2:#0f172a;
      --danger:#b91c1c;
      --ok:#059669;
      --warn:#b45309;
      --focus: rgba(17,24,39,.18);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: linear-gradient(180deg, #f3f4f6 0%, #eef2f7 100%);
    }

    header{ position:sticky; top:0; z-index:10; background: rgba(255,255,255,.85); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); }
    .topbar{ max-width:1300px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h1{ font-size:16px; margin:0; font-weight:750; letter-spacing:.2px; }
    .title small{ color:var(--muted); }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      background: rgba(255,255,255,.9);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--muted); }
    .dot.ok{ background: var(--ok); } .dot.err{ background: var(--danger); } .dot.warn{ background: var(--warn); }

    .app{ max-width:1300px; margin:0 auto; padding:16px; display:grid; grid-template-columns:260px 1fr; gap:14px; }
    @media (max-width:980px){ .app{ grid-template-columns:1fr; } }

    .nav{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: var(--panel);
      box-shadow:var(--shadow);
      padding:10px;
      position:sticky;
      top:66px;
      height:fit-content;
    }
    .nav button{
      width:100%; text-align:left;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:13px;
    }
    .nav button:hover{ background: rgba(17,24,39,.04); }
    .nav button.active{ background: rgba(17,24,39,.07); border-color: rgba(17,24,39,.12); }

    .tag{
      display:inline-block; padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      background: var(--panel2);
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: var(--panel);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line2);
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      background: linear-gradient(180deg, rgba(249,250,251,.95), rgba(255,255,255,.95));
    }
    .card .hd h2{ margin:0; font-size:14px; font-weight:750; }
    .card .hd p{ margin:0; color:var(--muted); font-size:12px; }
    .card .bd{ padding:14px; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    @media (max-width:780px){ .grid2,.grid3{ grid-template-columns:1fr; } }

    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input,select{
      width:100%;
      padding:10px 12px;
      border:1px solid rgba(17,24,39,.16);
      border-radius:12px;
      outline:none;
      background: #ffffff;
      color:var(--text);
    }
    input:focus,select:focus{
      border-color: rgba(17,24,39,.35);
      box-shadow: 0 0 0 4px var(--focus);
    }
    input[readonly]{ opacity:.9; background: #f9fafb; }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button.btn{
      border:1px solid rgba(17,24,39,.16);
      background: #ffffff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
    }
    button.btn:hover{ background: rgba(17,24,39,.03); }
    button.btn.primary{
      background: var(--primary);
      border-color: var(--primary);
      color: #ffffff;
    }
    button.btn.primary:hover{ background: #000; border-color:#000; }
    button.btn.danger{
      background: #fff;
      border-color: rgba(185,28,28,.35);
      color: var(--danger);
    }
    button.btn.danger:hover{ background: rgba(185,28,28,.05); }
    button.btn:disabled{ opacity:.55; cursor:not-allowed; }

    .sep{ height:1px; background: var(--line2); margin:14px 0; }

    .tableWrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:auto;
      max-height:520px;
      background: #ffffff;
    }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:10px 10px; border-bottom:1px solid rgba(17,24,39,.08); font-size:13px; vertical-align:top; }
    th{
      position:sticky; top:0;
      background: #f9fafb;
      color: #374151;
      font-weight:700;
      text-align:left;
      font-size:12px;
      border-bottom:1px solid rgba(17,24,39,.10);
    }
    td.right,th.right{ text-align:right; }

    .hide{ display:none !important; }
    .note{ color:var(--muted); font-size:12px; margin:8px 0 0; }

    /* Login overlay (BBC-like) */
    .overlay{
      position:fixed; inset:0; z-index:9999;
      background: rgba(17,24,39,.55);
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .loginBox{
      width:min(640px, 100%);
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px;
      background:#fff;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .bbcBar{
      background:#111;
      color:#fff;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .bbcLogo{
      display:flex; align-items:center; gap:6px;
      font-weight:900; letter-spacing:.6px; font-size:14px;
      user-select:none;
    }
    .bbcLogo span{
      display:inline-block;
      padding:4px 6px;
      background:#fff;
      color:#111;
      border-radius:4px;
      line-height:1;
    }
    .bbcBar small{ opacity:.9; font-weight:600; }

    .loginBody{ padding:16px; }
    .loginTitle{ margin:0; font-size:16px; font-weight:900; letter-spacing:.2px; }
    .loginSub{ margin:6px 0 0; color:#4b5563; font-size:13px; line-height:1.35; }

    .errText{ color:#991b1b; font-size:12px; margin-top:10px; }

    /* impressão: imprime somente #printArea */
    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }

      #printArea{
        display:block !important;
        position:absolute !important;
        left:0 !important;
        top:0 !important;
        width:100% !important;
        margin:0 !important;
      }

      body { background:#fff !important; color:#000 !important; }
      .card, .tableWrap { box-shadow:none !important; border: 0 !important; background: transparent !important; }
      th { position: static !important; background: transparent !important; color:#000 !important; }
    }
  </style>
</head>
<body>

<iframe id="sheetsSink" name="sheetsSink" style="display:none;width:0;height:0;border:0;"></iframe>

<!-- Login -->
<div class="overlay" id="loginOverlay" style="display:none;">
  <div class="loginBox">
    <div class="bbcBar">
      <div class="bbcLogo" aria-label="BBC style">
        <span>B</span><span>B</span><span>C</span>
      </div>
      <small>Controle de Uniformes</small>
    </div>

    <div class="loginBody">
      <h2 class="loginTitle">Entrar</h2>
      <p class="loginSub">Acesso permitido apenas para usuários autorizados pelo DEV. Use seu usuário e a senha de 6 dígitos.</p>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label for="loginUser">Usuário</label>
          <input id="loginUser" type="text" placeholder="Ex.: maria" autocomplete="username" />
        </div>
        <div>
          <label for="loginPass">Senha (6 dígitos)</label>
          <input id="loginPass" type="password" inputmode="numeric" placeholder="Ex.: 123456" autocomplete="current-password" />
        </div>
      </div>

      <div class="btns">
        <button type="button" class="btn primary" id="btnLogin">Entrar</button>
      </div>

      <div class="errText" id="loginErr" style="display:none;"></div>

      <div class="sep"></div>
      <p class="note">
        DEV: usuário <b>dayerre@gmail.com</b> + PIN mestre (6 dígitos).
      </p>
    </div>
  </div>
</div>

<header>
  <div class="topbar">
    <div class="title">
      <h1>Controle de Uniformes</h1>
      <small>Entrada • Saída • Devolução</small>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="chip" id="chipUser" title="Usuário atual">
        <span class="dot ok"></span>
        <span id="txtUser">Não logado</span>
      </div>
      <div class="chip">
        <span class="dot warn" id="dotSheets"></span>
        <span id="txtSheets">Sheets: configurado</span>
      </div>
      <button type="button" class="btn" id="btnLogout" style="padding:8px 10px;">Sair</button>
    </div>
  </div>
</header>

<main class="app">
  <aside class="nav">
    <button type="button" class="navBtn active" data-screen="mov">Movimentar <span class="tag">principal</span></button>
    <button type="button" class="navBtn" data-screen="func">Funcionários <span class="tag">cadastro</span></button>
    <button type="button" class="navBtn" data-screen="est">Estoque <span class="tag">saldo</span></button>

    <!-- DEV only -->
    <button type="button" class="navBtn devOnly hide" data-screen="cfg">Config <span class="tag">Sheets</span></button>
    <button type="button" class="navBtn devOnly hide" data-screen="log">Acessos <span class="tag">DEV</span></button>
  </aside>

  <!-- MOV -->
  <section id="screen-mov" class="card">
    <div class="hd">
      <div><h2>Movimentação</h2><p>Observação aparece somente em devolução.</p></div>
      <div class="chip"><span class="dot ok"></span><span id="pillTotal">Estoque: —</span></div>
    </div>
    <div class="bd">

      <div class="btns no-print" style="margin-top:0; margin-bottom:12px;">
        <button type="button" class="btn primary" id="btnCarregarSheetsUrl">Carregar Sheets</button>
      </div>

      <div class="grid3">
        <div>
          <label for="tipoMov">Tipo</label>
          <select id="tipoMov">
            <option value="ENTRADA">Entrada</option>
            <option value="SAIDA">Saída</option>
            <option value="DEVOLUCAO">Devolução</option>
          </select>
        </div>
        <div>
          <label for="dataMov">Data</label>
          <input id="dataMov" type="date" />
        </div>
        <div id="boxFunc" class="hide">
          <label for="funcionarioSel">Funcionário</label>
          <select id="funcionarioSel"></select>
        </div>
      </div>

      <div class="grid2">
        <div id="boxEstado" class="hide">
          <label for="estadoItem">Estado (devolução)</label>
          <select id="estadoItem">
            <option value="EM_CONDICOES">Em condições</option>
            <option value="SEM_CONDICOES">Sem condições</option>
          </select>
        </div>
        <div id="boxMotivo" class="hide">
          <label for="motivoRuim">Motivo (obrigatório)</label>
          <input id="motivoRuim" type="text" />
        </div>
      </div>

      <div class="grid3">
        <div>
          <label for="categoria">Categoria</label>
          <select id="categoria"></select>
        </div>
        <div>
          <label for="tamanho">Tamanho</label>
          <select id="tamanho"></select>
        </div>
        <div>
          <label for="quantidade">Quantidade</label>
          <input id="quantidade" type="number" min="1" step="1" value="1" />
        </div>
      </div>

      <div id="boxObs" class="hide">
        <label for="obs">Observação</label>
        <input id="obs" type="text" />
      </div>

      <div class="btns">
        <button type="button" class="btn primary" id="btnSalvar">Salvar</button>
        <button type="button" class="btn" id="btnLimpar">Limpar</button>
      </div>

      <div class="sep no-print"></div>

      <div class="grid2 no-print">
        <div>
          <label for="relFuncSel">Relatório por funcionário</label>
          <select id="relFuncSel"></select>
        </div>
        <div class="btns" style="align-items:end; justify-content:flex-end;">
          <button type="button" class="btn" id="btnGerarRel">Gerar relatório</button>
          <button type="button" class="btn" id="btnLimparRel">Limpar relatório</button>
          <button type="button" class="btn primary" id="btnImprimirRel">Imprimir</button>
          <button type="button" class="btn primary" id="btnImprimirTermoDia" disabled>Imprimir termo do dia</button>
        </div>
      </div>

      <div id="printArea" class="card" style="margin-top:12px; display:none;">
        <div class="hd" id="printHeader">
          <div>
            <h2 id="relTitulo">Relatório</h2>
            <p id="relSub">—</p>
          </div>
        </div>
        <div class="bd" id="printBody">
          <div class="tableWrap" style="max-height:none;">
            <table id="tblRelFunc">
              <thead>
                <tr>
                  <th>Data</th><th>Tipo</th><th>Item</th><th>Tam.</th>
                  <th class="right">Qtd</th><th>Estado</th><th>Motivo</th><th>Obs.</th>
                </tr>
              </thead>
              <tbody><tr><td colspan="8" class="note">—</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <h2 style="margin-top:14px;">Histórico</h2>
      <div class="tableWrap">
        <table id="tblHistorico">
          <thead>
          <tr>
            <th>Data</th><th>Tipo</th><th>Funcionário</th><th>Item</th><th>Tam.</th>
            <th class="right">Qtd</th><th>Estado</th><th>Motivo</th><th>Obs.</th>
            <th class="no-print">Ações</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- FUNC -->
  <section id="screen-func" class="card hide">
    <div class="hd"><div><h2>Funcionários</h2><p>Cadastro.</p></div></div>
    <div class="bd">
      <label for="novoNome">Novo funcionário</label>
      <input id="novoNome" type="text" />
      <div class="btns">
        <button type="button" class="btn primary" id="btnAddFunc">Adicionar</button>
      </div>
    </div>
  </section>

  <!-- EST -->
  <section id="screen-est" class="card hide">
    <div class="hd">
      <div><h2>Estoque</h2><p>Saldos atuais por item e tamanho.</p></div>
      <div class="chip"><span class="dot ok"></span><span id="pillTotal2">Total: —</span></div>
    </div>
    <div class="bd">
      <div class="tableWrap" style="max-height:520px;">
        <table id="tblEstoque">
          <thead><tr><th>Item</th><th>Tamanho</th><th class="right">Saldo</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CFG (DEV only) -->
  <section id="screen-cfg" class="card hide devOnlyScreen">
    <div class="hd"><div><h2>Config</h2><p>Somente DEV.</p></div></div>
    <div class="bd">
      <label for="cfgUrl">URL do Web App (/exec)</label>
      <input id="cfgUrl" type="text" readonly />
      <div class="sep"></div>
      <div class="btns">
        <button type="button" class="btn primary" id="btnReenviar">Reenviar pendentes</button>
        <button type="button" class="btn danger" id="btnLimparEnviados">Limpar enviados</button>
      </div>
    </div>
  </section>

  <!-- LOG/USERS (DEV only) -->
  <section id="screen-log" class="card hide devOnlyScreen">
    <div class="hd">
      <div><h2>Acessos (DEV)</h2><p>Log e controle de usuários.</p></div>
      <div class="chip"><span class="dot warn"></span><span id="logCount">—</span></div>
    </div>
    <div class="bd">
      <div class="grid2">
        <div class="card" style="overflow:hidden;">
          <div class="hd"><div><h2>Log</h2><p>Registro local.</p></div></div>
          <div class="bd">
            <div class="btns" style="margin-top:0;">
              <button type="button" class="btn" id="btnAtualizarLog">Atualizar</button>
              <button type="button" class="btn danger" id="btnLimparLog">Limpar log</button>
            </div>
            <div class="tableWrap" style="margin-top:12px; max-height:360px;">
              <table id="tblLog">
                <thead><tr><th>Quando</th><th>Usuário</th><th>Ação</th><th>Detalhe</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card" style="overflow:hidden;">
          <div class="hd"><div><h2>Usuários</h2><p>Criar/ativar/resetar.</p></div></div>
          <div class="bd">
            <label for="newUserLogin">Novo usuário (login)</label>
            <input id="newUserLogin" type="text" placeholder="Ex.: maria" />
            <label for="newUserName">Nome (opcional)</label>
            <input id="newUserName" type="text" placeholder="Ex.: Maria Silva" />
            <label for="newUserPin">Senha (6 dígitos)</label>
            <input id="newUserPin" type="password" inputmode="numeric" placeholder="Ex.: 123456" />

            <div class="btns">
              <button type="button" class="btn primary" id="btnCreateUser">Criar usuário</button>
            </div>

            <div class="sep"></div>

            <div class="tableWrap" style="max-height:320px;">
              <table id="tblUsers">
                <thead><tr><th>Login</th><th>Nome</th><th>Status</th><th class="right">Ações</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <p class="note">Controle local neste navegador.</p>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  const DB_KEY="uniformes_db_v2_layout";
  const QUEUE_KEY="uniformes_queue_v2_layout";
  const SHEETS_URL="https://script.google.com/macros/s/AKfycbzef2t-ivoNG_Hu5ACUby0VStJ4ald49HU6W-2sL2ixDKfJZpEz3cfvw5PKAKeLP-lkzQ/exec";
  const TERMO_LOCAL="Colatina/ES";

  const DEV_EMAIL="dayerre@gmail.com";
  // PIN mestre do DEV (6 dígitos) — troque aqui:
  const DEV_MASTER_PIN="123456";

  const SESSION_KEY="uniformes_session_admin_v2_light";
  const LOG_KEY="uniformes_auditlog_admin_v2_light";
  const USERS_KEY="uniformes_users_admin_v2_light";

  const CATALOG=[
    { categoria:"Camisa masculina manga longa", tamanhos:["P","M","G","GG","XG"] },
    { categoria:"Camisa masculina manga curta", tamanhos:["P","M","G","GG","XG"] },
    { categoria:"Calça brim c/ faixa refletiva (masc.)", tamanhos:["P","M","G","GG","XXG"] },
    { categoria:"Camisa feminina babylook", tamanhos:["P","M","G","GG","XXG"] },
  ];

  function todayISO(){ const d=new Date(); const pad=n=>String(n).padStart(2,"0"); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function nowISO(){ return new Date().toISOString(); }
  function formatBRDateFromISO(iso){ if(!iso||typeof iso!=="string"||iso.length<10) return ""; const [y,m,d]=iso.slice(0,10).split("-"); return `${d}/${m}/${y}`; }
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function makeId(){ try{ if(crypto?.randomUUID) return crypto.randomUUID(); }catch{} return String(Date.now())+"_"+Math.random().toString(16).slice(2); }
  function keyItem(c,t){ return `${c}__${t}`; }
  function isSixDigits(pass){ return /^\d{6}$/.test(String(pass||"").trim()); }
  function normLogin(s){ return String(s||"").trim().toLowerCase(); }

  function loadDB(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)) ?? {movimentos:[],estoque:{},funcionarios:[]}; }catch{ return {movimentos:[],estoque:{},funcionarios:[]}; } }
  function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
  function loadQueue(){ try{ return JSON.parse(localStorage.getItem(QUEUE_KEY)) ?? []; }catch{ return []; } }
  function saveQueue(q){ localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); }
  function getFuncById(db,id){ return db.funcionarios.find(f=>f.id===id)||null; }

  function loadSession(){ try{ return JSON.parse(localStorage.getItem(SESSION_KEY)) || null; }catch{ return null; } }
  function saveSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
  function clearSession(){ localStorage.removeItem(SESSION_KEY); }
  function getCurrentUser(){ const s=loadSession(); if(!s||!s.login) return null; return s; }
  function isDevSession(){ const s=getCurrentUser(); return !!(s && s.isDev); }

  function loadAudit(){ try{ return JSON.parse(localStorage.getItem(LOG_KEY)) ?? []; }catch{ return []; } }
  function saveAudit(arr){ localStorage.setItem(LOG_KEY, JSON.stringify(arr)); }
  function audit(action, detail){
    const s=getCurrentUser();
    const who=s ? (s.login + (s.isDev ? " (DEV)" : "")) : "SEM LOGIN";
    const entry={ id:makeId(), at:nowISO(), user:who, action:String(action||""), detail:String(detail||"") };
    const arr=loadAudit(); arr.push(entry);
    const MAX=1500; if(arr.length>MAX) arr.splice(0, arr.length - MAX);
    saveAudit(arr);
    renderLog();
  }

  function loadUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_KEY)) ?? []; }catch{ return []; } }
  function saveUsers(arr){ localStorage.setItem(USERS_KEY, JSON.stringify(arr)); }
  function findUserByLogin(login){
    const ulogin=normLogin(login);
    return loadUsers().find(u=>u.login===ulogin) || null;
  }

  // ===== Sheets status
  const dotSheets=document.getElementById("dotSheets");
  const txtSheets=document.getElementById("txtSheets");
  function setSheetsStatus(mode, msg){
    dotSheets.classList.remove("ok","err","warn");
    if(mode==="ok"){ dotSheets.classList.add("ok"); txtSheets.textContent=msg||"Sheets: configurado"; return; }
    if(mode==="erro"){ dotSheets.classList.add("err"); txtSheets.textContent=msg||"Sheets: erro"; return; }
    dotSheets.classList.add("warn"); txtSheets.textContent=msg||"Sheets: não configurado";
  }
  function refreshSheetsStatus(){ setSheetsStatus(SHEETS_URL ? "ok" : "warn", SHEETS_URL ? "Sheets: configurado" : "Sheets: não configurado"); }

  // ===== nav
  const navBtns=[...document.querySelectorAll(".navBtn")];
  const screens={
    mov:document.getElementById("screen-mov"),
    func:document.getElementById("screen-func"),
    est:document.getElementById("screen-est"),
    cfg:document.getElementById("screen-cfg"),
    log:document.getElementById("screen-log")
  };
  function setScreen(name){
    Object.entries(screens).forEach(([k,el])=>el.classList.toggle("hide", k!==name));
    navBtns.forEach(b=>b.classList.toggle("active", b.dataset.screen===name));
    if(name==="mov") renderMov();
    if(name==="func") renderFuncionariosSelect();
    if(name==="est") renderEstoque();
    if(name==="cfg") renderCfg();
    if(name==="log"){ renderLog(); renderUsersAdminUI(); }
  }
  navBtns.forEach(b=>b.addEventListener("click",()=>setScreen(b.dataset.screen)));

  // ===== Login
  const chipUser=document.getElementById("chipUser");
  const txtUser=document.getElementById("txtUser");
  const btnLogout=document.getElementById("btnLogout");
  const loginOverlay=document.getElementById("loginOverlay");
  const loginUser=document.getElementById("loginUser");
  const loginPass=document.getElementById("loginPass");
  const btnLogin=document.getElementById("btnLogin");
  const loginErr=document.getElementById("loginErr");

  function showLogin(){
    loginErr.style.display="none";
    loginErr.textContent="";
    loginOverlay.style.display="flex";
    setTimeout(()=>loginUser.focus(), 80);
  }
  function hideLogin(){ loginOverlay.style.display="none"; }
  function refreshUserChip(){
    const s=getCurrentUser();
    if(!s){ txtUser.textContent="Não logado"; chipUser.title="Sem login"; return; }
    txtUser.textContent = `Logado: ${s.login}${s.isDev ? " (DEV)" : ""}`;
    chipUser.title = `Desde: ${s.at || ""}`;
  }
  function applyDevVisibility(){
    const isDev=isDevSession();
    document.querySelectorAll(".devOnly").forEach(el=>el.classList.toggle("hide", !isDev));
    document.querySelectorAll(".devOnlyScreen").forEach(el=>el.classList.toggle("hide", !isDev));
    if(!isDev){
      // se estava em telas DEV, volta para mov
      if(!screens.cfg.classList.contains("hide") || !screens.log.classList.contains("hide")){
        setScreen("mov");
      }
    }
  }

  function requireLogin(){
    const s=getCurrentUser();
    if(!s){ showLogin(); return false; }
    return true;
  }

  function doLogin(){
    const login=normLogin(loginUser.value);
    const pass=String(loginPass.value||"").trim();

    if(!login){
      loginErr.textContent="Informe o usuário.";
      loginErr.style.display="block";
      return;
    }
    if(!isSixDigits(pass)){
      loginErr.textContent="Senha inválida. Use exatamente 6 dígitos.";
      loginErr.style.display="block";
      return;
    }

    const isDevAttempt = login === normLogin(DEV_EMAIL);
    if(isDevAttempt){
      if(pass !== DEV_MASTER_PIN){
        loginErr.textContent="PIN do DEV incorreto.";
        loginErr.style.display="block";
        return;
      }
      saveSession({ login, isDev:true, at:new Date().toLocaleString("pt-BR") });
      hideLogin();
      refreshUserChip();
      applyDevVisibility();
      audit("LOGIN_DEV", "Entrou como DEV");
      return;
    }

    const u=findUserByLogin(login);
    if(!u){
      loginErr.textContent="Usuário não cadastrado. Solicite ao DEV.";
      loginErr.style.display="block";
      return;
    }
    if(!u.active){
      loginErr.textContent="Usuário desativado. Solicite ao DEV.";
      loginErr.style.display="block";
      return;
    }
    if(pass !== u.pin){
      loginErr.textContent="Senha incorreta.";
      loginErr.style.display="block";
      return;
    }

    saveSession({ login, isDev:false, at:new Date().toLocaleString("pt-BR") });
    hideLogin();
    refreshUserChip();
    applyDevVisibility();
    audit("LOGIN", "Entrou no sistema");
  }

  btnLogin.addEventListener("click", doLogin);
  loginPass.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  loginUser.addEventListener("keydown", (e)=>{ if(e.key==="Enter") loginPass.focus(); });

  btnLogout.addEventListener("click", ()=>{
    const s=getCurrentUser();
    if(s) audit("LOGOUT", "Saiu do sistema");
    clearSession();
    refreshUserChip();
    applyDevVisibility();
    showLogin();
  });

  // ===== DEV users/log UI
  const logCount=document.getElementById("logCount");
  const tblLogBody=document.querySelector("#tblLog tbody");
  const btnAtualizarLog=document.getElementById("btnAtualizarLog");
  const btnLimparLog=document.getElementById("btnLimparLog");

  function renderLog(){
    if(screens.log.classList.contains("hide")) return;
    const arr=loadAudit().slice().reverse();
    logCount.textContent=`${arr.length} registro(s)`;
    tblLogBody.innerHTML = arr.map(e=>`
      <tr>
        <td>${escapeHtml(new Date(e.at).toLocaleString("pt-BR"))}</td>
        <td>${escapeHtml(e.user)}</td>
        <td>${escapeHtml(e.action)}</td>
        <td>${escapeHtml(e.detail)}</td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="note">Sem registros.</td></tr>`;
  }
  btnAtualizarLog.addEventListener("click", ()=>{ if(!requireLogin()) return; if(!isDevSession()) return alert("Somente DEV."); renderLog(); });
  btnLimparLog.addEventListener("click", ()=>{
    if(!requireLogin()) return;
    if(!isDevSession()) return alert("Somente DEV.");
    if(!confirm("Limpar o log deste navegador?")) return;
    saveAudit([]);
    audit("LOG_CLEAR", "Limpou o log");
    renderLog();
  });

  const newUserLogin=document.getElementById("newUserLogin");
  const newUserName=document.getElementById("newUserName");
  const newUserPin=document.getElementById("newUserPin");
  const btnCreateUser=document.getElementById("btnCreateUser");
  const tblUsersBody=document.querySelector("#tblUsers tbody");

  function renderUsersAdminUI(){
    if(screens.log.classList.contains("hide")) return;
    if(!isDevSession()) return;

    const users=loadUsers().slice().sort((a,b)=>a.login.localeCompare(b.login));
    tblUsersBody.innerHTML = users.map(u=>`
      <tr>
        <td>${escapeHtml(u.login)}</td>
        <td>${escapeHtml(u.name||"—")}</td>
        <td>${u.active ? "Ativo" : "Inativo"}</td>
        <td class="right">
          <button class="btn" type="button" onclick="toggleUser('${escapeHtml(u.login)}')">${u.active ? "Desativar" : "Ativar"}</button>
          <button class="btn" type="button" onclick="resetPin('${escapeHtml(u.login)}')">Reset senha</button>
          <button class="btn danger" type="button" onclick="removeUser('${escapeHtml(u.login)}')">Remover</button>
        </td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="note">Nenhum usuário cadastrado.</td></tr>`;
  }

  function toggleUser(login){
    if(!isDevSession()) return alert("Somente DEV.");
    const users=loadUsers();
    const i=users.findIndex(u=>u.login===normLogin(login));
    if(i<0) return;
    users[i].active=!users[i].active;
    saveUsers(users);
    audit("USER_TOGGLE", `${users[i].login} => ${users[i].active ? "ATIVO" : "INATIVO"}`);
    renderUsersAdminUI();
  }
  function resetPin(login){
    if(!isDevSession()) return alert("Somente DEV.");
    const novo=prompt("Nova senha (6 dígitos):");
    if(novo===null) return;
    if(!isSixDigits(novo)) return alert("Precisa ser 6 dígitos.");
    const users=loadUsers();
    const i=users.findIndex(u=>u.login===normLogin(login));
    if(i<0) return;
    users[i].pin=String(novo).trim();
    saveUsers(users);
    audit("USER_RESET_PIN", `${users[i].login}`);
    renderUsersAdminUI();
  }
  function removeUser(login){
    if(!isDevSession()) return alert("Somente DEV.");
    if(!confirm("Remover usuário?")) return;
    saveUsers(loadUsers().filter(u=>u.login!==normLogin(login)));
    audit("USER_REMOVE", normLogin(login));
    renderUsersAdminUI();
  }
  window.toggleUser=toggleUser;
  window.resetPin=resetPin;
  window.removeUser=removeUser;

  btnCreateUser.addEventListener("click", ()=>{
    if(!requireLogin()) return;
    if(!isDevSession()) return alert("Somente DEV.");

    const login=normLogin(newUserLogin.value);
    const name=String(newUserName.value||"").trim();
    const pin=String(newUserPin.value||"").trim();

    if(!login) return alert("Informe o login do usuário.");
    if(login===normLogin(DEV_EMAIL)) return alert("Este login é reservado para o DEV.");
    if(!isSixDigits(pin)) return alert("Senha precisa ter 6 dígitos.");

    const users=loadUsers();
    if(users.some(u=>u.login===login)) return alert("Usuário já existe.");

    users.push({ login, name, pin, active:true, createdAt: nowISO() });
    saveUsers(users);

    audit("USER_CREATE", `${login}${name?(" | "+name):""}`);

    newUserLogin.value=""; newUserName.value=""; newUserPin.value="";
    renderUsersAdminUI();
    alert("Usuário criado.");
  });

  // ===== app logic
  const elTipo=document.getElementById("tipoMov");
  const elData=document.getElementById("dataMov");
  const boxFunc=document.getElementById("boxFunc");
  const elFuncSel=document.getElementById("funcionarioSel");
  const boxEstado=document.getElementById("boxEstado");
  const elEstado=document.getElementById("estadoItem");
  const boxMotivo=document.getElementById("boxMotivo");
  const elMotivo=document.getElementById("motivoRuim");
  const elCat=document.getElementById("categoria");
  const elTam=document.getElementById("tamanho");
  const elQtd=document.getElementById("quantidade");
  const boxObs=document.getElementById("boxObs");
  const elObs=document.getElementById("obs");
  const btnSalvar=document.getElementById("btnSalvar");
  const btnLimpar=document.getElementById("btnLimpar");
  const tblHistBody=document.querySelector("#tblHistorico tbody");

  const relFuncSel=document.getElementById("relFuncSel");
  const btnGerarRel=document.getElementById("btnGerarRel");
  const btnLimparRel=document.getElementById("btnLimparRel");
  const btnImprimirRel=document.getElementById("btnImprimirRel");
  const btnImprimirTermoDia=document.getElementById("btnImprimirTermoDia");

  const printArea=document.getElementById("printArea");
  const printHeader=document.getElementById("printHeader");
  const printBody=document.getElementById("printBody");
  const relTitulo=document.getElementById("relTitulo");
  const relSub=document.getElementById("relSub");

  const elNovoNome=document.getElementById("novoNome");
  const btnAddFunc=document.getElementById("btnAddFunc");

  const cfgUrl=document.getElementById("cfgUrl");
  const btnReenviar=document.getElementById("btnReenviar");
  const btnLimparEnviados=document.getElementById("btnLimparEnviados");

  const tblEstoqueBody=document.querySelector("#tblEstoque tbody");
  const pillTotal=document.getElementById("pillTotal");
  const pillTotal2=document.getElementById("pillTotal2");

  const btnCarregarSheetsUrl=document.getElementById("btnCarregarSheetsUrl");

  function keyItem(c,t){ return `${c}__${t}`; }
  function upsertEstoque(db,c,t,delta){ const k=keyItem(c,t); db.estoque[k]=Number(db.estoque[k]??0)+delta; }

  function fillCategorias(){ elCat.innerHTML=CATALOG.map(c=>`<option value="${escapeHtml(c.categoria)}">${escapeHtml(c.categoria)}</option>`).join(""); }
  function fillTamanhos(){
    const found=CATALOG.find(x=>x.categoria===elCat.value);
    const ts=found?found.tamanhos:[];
    elTam.innerHTML=ts.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
  }
  function fillRelFuncionarios(){
    const db=loadDB();
    const todos=db.funcionarios.slice().sort((a,b)=>a.nome.localeCompare(b.nome));
    relFuncSel.innerHTML=[`<option value="">(Selecione)</option>`].concat(
      todos.map(f=>`<option value="${escapeHtml(f.id)}">${escapeHtml(f.nome + (f.ativo ? "" : " [inativo]"))}</option>`)
    ).join("");
  }
  function renderFuncionariosSelect(){
    const db=loadDB();
    const ativos=db.funcionarios.filter(f=>f.ativo).sort((a,b)=>a.nome.localeCompare(b.nome));
    elFuncSel.innerHTML=[`<option value="">(Selecione)</option>`].concat(
      ativos.map(f=>`<option value="${escapeHtml(f.id)}">${escapeHtml(f.nome)}</option>`)
    ).join("");
    fillRelFuncionarios();
  }
  function updateMovUI(){
    const tipo=elTipo.value;
    const precisa=(tipo==="SAIDA"||tipo==="DEVOLUCAO");
    const isDev=(tipo==="DEVOLUCAO");
    const isSem=isDev && (elEstado.value==="SEM_CONDICOES");
    boxFunc.classList.toggle("hide", !precisa);
    boxEstado.classList.toggle("hide", !isDev);
    boxMotivo.classList.toggle("hide", !isSem);
    boxObs.classList.toggle("hide", !isDev);
    if(!isDev) elObs.value="";
    if(!precisa) elFuncSel.value="";
    if(!isSem) elMotivo.value="";
  }
  function tipoLabel(t){ return t==="SAIDA" ? "SAÍDA" : (t==="DEVOLUCAO" ? "DEVOLUÇÃO" : t); }
  function estadoLabel(e){ if(!e) return "—"; if(e==="EM_CONDICOES") return "Em condições"; if(e==="SEM_CONDICOES") return "Sem condições"; return e; }

  function renderEstoque(){
    const db=loadDB();
    let total=0;
    const rows=[];
    Object.entries(db.estoque).map(([k,v])=>{
      const [c,t]=k.split("__");
      return {c,t,s:Number(v)};
    }).sort((a,b)=>(a.c+a.t).localeCompare(b.c+b.t)).forEach(it=>{
      total += it.s;
      rows.push(`<tr><td>${escapeHtml(it.c)}</td><td>${escapeHtml(it.t)}</td><td class="right">${it.s}</td></tr>`);
    });
    tblEstoqueBody.innerHTML = rows.join("") || `<tr><td colspan="3" class="note">Sem itens.</td></tr>`;
    pillTotal.textContent = `Estoque: ${total} peça(s)`;
    pillTotal2.textContent = `Total: ${total} peça(s)`;
  }

  function renderCfg(){ cfgUrl.value=SHEETS_URL; }

  function renderMov(){
    renderFuncionariosSelect();
    renderEstoque();
    const db=loadDB();
    const hist=[...db.movimentos].filter(m=>!m.hidden).reverse().slice(0,250);
    tblHistBody.innerHTML = hist.map(m=>{
      const f=m.funcionarioId?getFuncById(db,m.funcionarioId):null;
      return `<tr>
        <td>${escapeHtml(m.data)}</td>
        <td>${escapeHtml(tipoLabel(m.tipo))}</td>
        <td>${escapeHtml(f?f.nome:"—")}</td>
        <td>${escapeHtml(m.categoria)}</td>
        <td>${escapeHtml(m.tamanho)}</td>
        <td class="right">${Number(m.quantidade)}</td>
        <td>${escapeHtml(estadoLabel(m.estado))}</td>
        <td>${escapeHtml(m.motivo||"—")}</td>
        <td>${escapeHtml(m.obs||"")}</td>
        <td class="no-print">
          <button type="button" class="btn danger" onclick="hideMovimento('${escapeHtml(m.id)}')">Excluir</button>
        </td>
      </tr>`;
    }).join("") || `<tr><td colspan="10" class="note">Sem movimentações.</td></tr>`;
  }

  function limparRelatorioUI(){
    printHeader.style.display="flex";
    printBody.innerHTML = `
      <div class="tableWrap" style="max-height:none;">
        <table id="tblRelFunc">
          <thead>
            <tr>
              <th>Data</th><th>Tipo</th><th>Item</th><th>Tam.</th>
              <th class="right">Qtd</th><th>Estado</th><th>Motivo</th><th>Obs.</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="8" class="note">—</td></tr></tbody>
        </table>
      </div>
    `;
    printArea.style.display="none";
    btnImprimirTermoDia.disabled=true;
  }

  function gerarRelatorioFuncionario(){
    const db=loadDB();
    const id=relFuncSel.value;
    if(!id){ limparRelatorioUI(); return; }
    btnImprimirTermoDia.disabled=false;

    const movs=db.movimentos.filter(m=>!m.hidden && m.funcionarioId===id).slice()
      .sort((a,b)=>String(a.data).localeCompare(String(b.data)));

    printHeader.style.display="none";
    printBody.innerHTML=`
      <div style="max-width: 980px; margin: 0 auto; padding: 0 6px;">
        <div class="tableWrap" style="max-height:none;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>Data</th><th>Tipo</th><th>Item</th><th>Tam.</th>
                <th class="right">Qtd</th><th>Estado</th><th>Motivo</th><th>Obs.</th>
              </tr>
            </thead>
            <tbody>
              ${
                movs.length
                  ? movs.map(m=>`
                      <tr>
                        <td>${escapeHtml(m.data)}</td>
                        <td>${escapeHtml(tipoLabel(m.tipo))}</td>
                        <td>${escapeHtml(m.categoria)}</td>
                        <td>${escapeHtml(m.tamanho)}</td>
                        <td class="right">${Number(m.quantidade)}</td>
                        <td>${escapeHtml(estadoLabel(m.estado))}</td>
                        <td>${escapeHtml(m.motivo || "—")}</td>
                        <td>${escapeHtml(m.obs || "")}</td>
                      </tr>
                    `).join("")
                  : `<tr><td colspan="8" class="note">Sem registros.</td></tr>`
              }
            </tbody>
          </table>
        </div>
      </div>
    `;
    printArea.style.display="block";
    printArea.scrollIntoView({behavior:"smooth", block:"start"});
    audit("RELATORIO_GERAR", `FuncionárioId: ${id}, registros: ${movs.length}`);
  }

  // ===== queue
  function enqueue(kind,payload){
    const q=loadQueue();
    q.push({qid:makeId(), kind, payload, status:"PENDENTE", tries:0, lastError:"", createdAt:new Date().toISOString()});
    saveQueue(q);
  }
  function postToSheets(kind,payload){
    const form=document.createElement("form");
    form.method="POST";
    form.action=SHEETS_URL;
    form.target="sheetsSink";
    const iKind=document.createElement("input"); iKind.type="hidden"; iKind.name="kind"; iKind.value=kind;
    const iPayload=document.createElement("input"); iPayload.type="hidden"; iPayload.name="payload"; iPayload.value=JSON.stringify(payload);
    form.appendChild(iKind); form.appendChild(iPayload);
    document.body.appendChild(form);
    form.submit();
    form.remove();
  }
  async function processQueue(limit=10){
    const q=loadQueue();
    let sent=0;
    for(const item of q){
      if(sent>=limit) break;
      if(item.status==="ENVIADO") continue;
      item.status="ENVIANDO"; item.tries=(item.tries||0)+1; saveQueue(q);
      try{
        postToSheets(item.kind,item.payload);
        item.status="ENVIADO"; item.lastError=""; sent++; setSheetsStatus("ok","Sheets: enviado");
      }catch(err){
        item.status="ERRO"; item.lastError=String(err?.message||err); setSheetsStatus("erro","Sheets: erro");
      }
      saveQueue(q);
    }
  }

  // ===== actions with login
  function hideMovimento(id){
    if(!requireLogin()) return;
    if(!confirm("Ocultar este registro?")) return;
    const db=loadDB();
    const m=db.movimentos.find(x=>x.id===id);
    if(!m) return;
    m.hidden=true;
    saveDB(db);
    audit("EXCLUIR_VISUAL", `Movimento id=${id}`);
    renderMov();
  }
  window.hideMovimento=hideMovimento;

  btnCarregarSheetsUrl.addEventListener("click", ()=>{
    if(!requireLogin()) return;
    refreshSheetsStatus();
    processQueue(5);
    audit("SHEETS_CARREGAR", "Carregar Sheets");
    alert("Sheets carregado.");
  });

  btnGerarRel.addEventListener("click", ()=>{
    if(!requireLogin()) return;
    gerarRelatorioFuncionario();
  });
  btnLimparRel.addEventListener("click", ()=>{
    relFuncSel.value=""; limparRelatorioUI();
  });
  relFuncSel.addEventListener("change", ()=>{
    if(!relFuncSel.value) limparRelatorioUI();
  });
  btnImprimirRel.addEventListener("click", ()=>{
    if(printArea.style.display==="none"){
      if(!requireLogin()) return;
      gerarRelatorioFuncionario();
    }
    if(printArea.style.display==="none") return;
    audit("IMPRIMIR_RELATORIO", "Relatório por funcionário");
    window.print();
  });

  function gerarTermosDoDia(){
    const db=loadDB();
    const hoje=todayISO();
    const hojeBR=formatBRDateFromISO(hoje);
    const saidasHoje=db.movimentos.filter(m => !m.hidden && m.tipo==="SAIDA" && m.data===hoje && m.funcionarioId);
    if(saidasHoje.length===0){ alert("Não há SAÍDAS hoje."); return; }

    const porFunc=new Map();
    for(const m of saidasHoje){
      const arr=porFunc.get(m.funcionarioId)||[];
      arr.push(m);
      porFunc.set(m.funcionarioId, arr);
    }

    let html="";
    for(const [funcId, movs] of porFunc.entries()){
      const f=getFuncById(db, funcId);
      const nome=f ? f.nome : funcId;

      const itens=new Map();
      for(const m of movs){
        const k=`${m.categoria}||${m.tamanho}`;
        itens.set(k, (itens.get(k)||0) + Number(m.quantidade||0));
      }
      const linhas=[...itens.entries()].map(([k,q])=>{
        const [cat,tam]=k.split("||");
        return `<tr><td>${escapeHtml(cat)}</td><td>${escapeHtml(tam)}</td><td class="right">${q}</td></tr>`;
      }).join("");

      html += `
        <div style="page-break-after: always;">
          <div style="max-width: 780px; margin: 0 auto; padding: 0 6px; font-size: 14.5px;">
            <h2 style="margin:0 0 14px 0; text-align:center; letter-spacing:.4px; font-size: 16.5px;">
              TERMO DE RECEBIMENTO UNIFORME
            </h2>

            <p style="margin:0 0 12px 0; text-align:justify; text-justify:inter-word; line-height:1.55;">
              Eu, ${escapeHtml(nome)} Recebi da empresa: INTERCOL SERVIÇOS DE INTERNET LTDA
              CNPJ: 03.879.067/0001-36, os uniformes relacionados nesta ficha, declaro tê-los recebidos gratuitamente e em perfeito estado de conservação.
              Comprometo-me a utilizá-los diariamente durante toda a jornada de trabalho, responsabilizando-me pela guarda e conservação dos mesmos.
              Autorizo desde já, o desconto de seus respectivos valores em folha de pagamento/rescisão, quando por extravio e/ou danificação por uso inadequado,
              conforme previsto no artigo 462 §1º da CLT.
            </p>

            <div class="tableWrap" style="max-height:none;">
              <table style="width:100%; border-collapse:collapse; font-size: 13.5px;">
                <thead><tr><th>Material entregue</th><th>Tam.</th><th class="right">Qtd</th></tr></thead>
                <tbody>${linhas}</tbody>
              </table>
            </div>

            <div style="margin-top:18px; text-align:right;">
              ${escapeHtml(TERMO_LOCAL)}, ${escapeHtml(hojeBR)}
            </div>

            <div style="margin-top:30px;">
              <div style="height:60px;"></div>
              <div style="border-top:1px solid #000; padding-top:6px; text-align:center;">
                ${escapeHtml(nome)}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    printHeader.style.display="none";
    printBody.innerHTML=html;
    printArea.style.display="block";
    printArea.scrollIntoView({behavior:"smooth", block:"start"});
    audit("IMPRIMIR_TERMO_DIA", `Termo do dia ${hojeBR} (funcionários: ${porFunc.size})`);
    window.print();
  }
  btnImprimirTermoDia.addEventListener("click", ()=>{
    if(!requireLogin()) return;
    gerarTermosDoDia();
  });

  btnSalvar.addEventListener("click", ()=>{
    if(!requireLogin()) return;

    const db=loadDB();
    const tipo=elTipo.value;
    if(!elData.value) return alert("Informe a data.");
    const qtd=Number(elQtd.value);
    if(!Number.isFinite(qtd)||qtd<=0) return alert("Quantidade inválida.");
    if((tipo==="SAIDA"||tipo==="DEVOLUCAO") && !elFuncSel.value) return alert("Selecione o funcionário.");
    if(tipo==="DEVOLUCAO" && elEstado.value==="SEM_CONDICOES" && !elMotivo.value.trim()) return alert("Informe o motivo.");

    const mov={
      id:makeId(), tipo, data:elData.value,
      funcionarioId:(tipo==="SAIDA"||tipo==="DEVOLUCAO")?elFuncSel.value:"",
      categoria:elCat.value, tamanho:elTam.value,
      quantidade:qtd,
      estado:(tipo==="DEVOLUCAO")?elEstado.value:"",
      motivo:(tipo==="DEVOLUCAO" && elEstado.value==="SEM_CONDICOES")?elMotivo.value.trim():"",
      obs:(tipo==="DEVOLUCAO") ? elObs.value.trim() : "",
      hidden:false
    };

    let delta=0;
    if(tipo==="ENTRADA") delta=qtd;
    if(tipo==="SAIDA") delta=-qtd;
    if(tipo==="DEVOLUCAO") delta=(mov.estado==="EM_CONDICOES")?qtd:0;

    if(tipo==="SAIDA"){
      const k=keyItem(mov.categoria,mov.tamanho);
      const saldo=Number(db.estoque[k]??0);
      if(saldo+delta<0) return alert("Saldo insuficiente.");
    }

    if(delta!==0) upsertEstoque(db,mov.categoria,mov.tamanho,delta);
    db.movimentos.push(mov);
    saveDB(db);

    const f=mov.funcionarioId?getFuncById(db,mov.funcionarioId):null;
    enqueue("movimento", { ...mov, funcionarioNome: f?f.nome:"" });
    processQueue(3);

    audit("MOV_SALVAR", `${tipo} | ${mov.categoria} | ${mov.tamanho} | qtd=${qtd}${f?(" | func="+f.nome):""}`);

    elObs.value=""; elQtd.value="1"; elMotivo.value="";
    updateMovUI(); renderMov();
  });

  btnLimpar.addEventListener("click", ()=>{
    elTipo.value="ENTRADA";
    elFuncSel.value="";
    elEstado.value="EM_CONDICOES";
    elQtd.value="1";
    elMotivo.value="";
    elObs.value="";
    elData.value=todayISO();
    fillTamanhos();
    updateMovUI();
  });

  btnAddFunc.addEventListener("click", ()=>{
    if(!requireLogin()) return;
    const nome=String(elNovoNome.value||"").trim();
    if(!nome) return alert("Informe o nome.");
    const db=loadDB();
    if(db.funcionarios.some(f=>f.nome.toLowerCase()===nome.toLowerCase())) return alert("Já existe.");
    const fobj={ id:makeId(), nome, ativo:true };
    db.funcionarios.push(fobj);
    saveDB(db);
    enqueue("funcionario", { ...fobj, evento:"CADASTRO" });
    processQueue(3);
    audit("FUNC_ADICIONAR", nome);
    elNovoNome.value="";
    alert("Funcionário cadastrado.");
  });

  btnReenviar.addEventListener("click", ()=>{
    if(!requireLogin()) return;
    if(!isDevSession()) return alert("Somente DEV.");
    audit("QUEUE_REENVIAR", "Reenviou pendentes");
    processQueue(30);
  });

  btnLimparEnviados.addEventListener("click", ()=>{
    if(!requireLogin()) return;
    if(!isDevSession()) return alert("Somente DEV.");
    if(!confirm("Remover enviados?")) return;
    const before=loadQueue().length;
    saveQueue(loadQueue().filter(it=>it.status!=="ENVIADO"));
    const after=loadQueue().length;
    audit("QUEUE_LIMPAR_ENVIADOS", `Antes=${before} Depois=${after}`);
  });

  function boot(){
    fillCategorias();
    fillTamanhos();
    fillRelFuncionarios();

    elData.value=todayISO();
    renderCfg();
    renderFuncionariosSelect();
    updateMovUI();
    renderMov();
    setScreen("mov");

    refreshSheetsStatus();
    limparRelatorioUI();
    refreshUserChip();
    applyDevVisibility();

    elTipo.addEventListener("change", updateMovUI);
    elEstado.addEventListener("change", updateMovUI);
    elCat.addEventListener("change", fillTamanhos);

    if(!getCurrentUser()){
      showLogin();
    }else{
      audit("SESSION_RESUME", "Sessão retomada");
    }

    setInterval(()=> {
      const q=loadQueue();
      if(q.some(it=>it.status!=="ENVIADO")) processQueue(5);
    }, 30000);
  }

  boot();
</script>
</body>
</html>
