<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Uniformes</title>
  <style>
    :root{--bg:#f3f4f6;--panel:#fff;--panel2:#f9fafb;--text:#111827;--muted:#6b7280;--line:rgba(17,24,39,.12);--line2:rgba(17,24,39,.08);--shadow:0 12px 28px rgba(17,24,39,.10);--radius:14px;--primary:#111827;--danger:#b91c1c;--ok:#059669;--warn:#b45309;--focus: rgba(17,24,39,.18)}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:linear-gradient(180deg,#f3f4f6 0%,#eef2f7 100%)}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .topbar{max-width:1300px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{font-size:16px;margin:0;font-weight:750;letter-spacing:.2px}
    .title small{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px;background:rgba(255,255,255,.9);white-space:nowrap}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted)}
    .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)} .dot.warn{background:var(--warn)}
    .app{max-width:1300px;margin:0 auto;padding:16px;display:grid;grid-template-columns:260px 1fr;gap:14px}
    @media (max-width:980px){.app{grid-template-columns:1fr}}
    .nav{border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);box-shadow:var(--shadow);padding:10px;position:sticky;top:66px;height:fit-content}
    .nav button{width:100%;text-align:left;border:1px solid transparent;background:transparent;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:10px;font-size:13px}
    .nav button:hover{background:rgba(17,24,39,.04)}
    .nav button.active{background:rgba(17,24,39,.07);border-color:rgba(17,24,39,.12)}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px;background:var(--panel2)}
    .card{border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);box-shadow:var(--shadow);overflow:hidden}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line2);display:flex;align-items:flex-end;justify-content:space-between;gap:12px;background:linear-gradient(180deg, rgba(249,250,251,.95), rgba(255,255,255,.95))}
    .card .hd h2{margin:0;font-size:14px;font-weight:750}
    .card .hd p{margin:0;color:var(--muted);font-size:12px}
    .card .bd{padding:14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:780px){.grid2,.grid3{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select{width:100%;padding:10px 12px;border:1px solid rgba(17,24,39,.16);border-radius:12px;outline:none;background:#fff;color:var(--text)}
    input:focus,select:focus{border-color:rgba(17,24,39,.35);box-shadow:0 0 0 4px var(--focus)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button.btn{border:1px solid rgba(17,24,39,.16);background:#fff;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-size:13px}
    button.btn:hover{background:rgba(17,24,39,.03)}
    button.btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    button.btn.primary:hover{background:#000;border-color:#000}
    button.btn.danger{background:#fff;border-color:rgba(185,28,28,.35);color:var(--danger)}
    button.btn.danger:hover{background:rgba(185,28,28,.05)}
    button.btn:disabled{opacity:.55;cursor:not-allowed}
    .sep{height:1px;background:var(--line2);margin:14px 0}
    .tableWrap{border:1px solid var(--line);border-radius:14px;overflow:auto;max-height:520px;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(17,24,39,.08);font-size:13px;vertical-align:top}
    th{position:sticky;top:0;background:#f9fafb;color:#374151;font-weight:700;text-align:left;font-size:12px;border-bottom:1px solid rgba(17,24,39,.10)}
    td.right,th.right{text-align:right}
    .hide{display:none !important}
    .note{color:var(--muted);font-size:12px;margin:8px 0 0}
    .errText{color:#991b1b;font-size:12px;margin-top:10px}
    .overlay{position:fixed;inset:0;z-index:9999;background:rgba(17,24,39,.55);display:flex;align-items:center;justify-content:center;padding:16px}
    .loginBox{width:min(640px,100%);border:1px solid rgba(255,255,255,.18);border-radius:16px;background:#fff;box-shadow:0 18px 50px rgba(0,0,0,.35);overflow:hidden}
    .brandBar{background:#111;color:#fff;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brandLogo{display:flex;align-items:center;gap:8px;font-weight:900;letter-spacing:.6px;font-size:14px;user-select:none}
    .brandLogo .mark{display:inline-block;padding:4px 8px;background:#fff;color:#111;border-radius:4px;line-height:1;font-weight:950;letter-spacing:.8px}
    .brandBar small{opacity:.9;font-weight:600}
    .loginBody{padding:16px}
    .loginTitle{margin:0;font-size:16px;font-weight:900;letter-spacing:.2px}
    .loginSub{margin:6px 0 0;color:#4b5563;font-size:13px;line-height:1.35}
    @media print{
      body *{visibility:hidden !important}
      #printArea,#printArea *{visibility:visible !important}
      #printArea{display:block !important;position:absolute !important;left:0 !important;top:0 !important;width:100% !important;margin:0 !important}
      body{background:#fff !important;color:#000 !important}
      .card,.tableWrap{box-shadow:none !important;border:0 !important;background:transparent !important}
      th{position:static !important;background:transparent !important;color:#000 !important}
    }
  </style>
</head>
<body>

<div class="overlay" id="loginOverlay" style="display:none;">
  <div class="loginBox">
    <div class="brandBar">
      <div class="brandLogo" aria-label="INTERCOL"><span class="mark">INTERCOL</span></div>
      <small>Controle de Uniformes</small>
    </div>
    <div class="loginBody">
      <h2 class="loginTitle">Entrar</h2>
      <p class="loginSub">Use seu usuário e a senha (6 dígitos). Usuários são gerenciados pelo DEV no Sheets.</p>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label for="loginUser">Usuário</label>
          <input id="loginUser" type="text" placeholder="Ex.: maria" autocomplete="username" />
        </div>
        <div>
          <label for="loginPass">Senha (6 dígitos)</label>
          <input id="loginPass" type="password" inputmode="numeric" placeholder="Ex.: 123456" autocomplete="current-password" />
        </div>
      </div>

      <div class="btns">
        <button type="button" class="btn primary" id="btnLogin">Entrar</button>
      </div>

      <div class="errText" id="loginErr" style="display:none;"></div>
      <div class="sep"></div>
      <p class="note">DEV: usuário <b>dayerre@gmail.com</b> + PIN mestre (6 dígitos).</p>
    </div>
  </div>
</div>

<header>
  <div class="topbar">
    <div class="title">
      <h1>Controle de Uniformes</h1>
      <small>Entrada • Saída • Devolução</small>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="chip" id="chipUser" title="Usuário atual">
        <span class="dot ok"></span>
        <span id="txtUser">Não logado</span>
      </div>
      <div class="chip">
        <span class="dot warn" id="dotSheets"></span>
        <span id="txtSheets">Sheets: —</span>
      </div>
      <button type="button" class="btn" id="btnLogout" style="padding:8px 10px;">Sair</button>
    </div>
  </div>
</header>

<main class="app">
  <aside class="nav">
    <button type="button" class="navBtn active" data-screen="mov">Movimentar <span class="tag">principal</span></button>
    <button type="button" class="navBtn" data-screen="func">Funcionários <span class="tag">cadastro</span></button>
    <button type="button" class="navBtn" data-screen="est">Estoque <span class="tag">saldo</span></button>
    <button type="button" class="navBtn devOnly hide" data-screen="cfg">Config <span class="tag">DEV</span></button>
    <button type="button" class="navBtn devOnly hide" data-screen="log">Acessos <span class="tag">DEV</span></button>
  </aside>

  <!-- telas (iguais) -->
  <section id="screen-mov" class="card">
    <div class="hd">
      <div><h2>Movimentação</h2><p>Observação aparece somente em devolução.</p></div>
      <div class="chip"><span class="dot ok"></span><span id="pillTotal">Estoque: —</span></div>
    </div>
    <div class="bd">
      <div class="btns no-print" style="margin-top:0; margin-bottom:12px;">
        <button type="button" class="btn primary" id="btnCarregarSheetsUrl">Carregar Sheets</button>
      </div>

      <div class="grid3">
        <div>
          <label for="tipoMov">Tipo</label>
          <select id="tipoMov">
            <option value="ENTRADA">Entrada</option>
            <option value="SAIDA">Saída</option>
            <option value="DEVOLUCAO">Devolução</option>
          </select>
        </div>
        <div>
          <label for="dataMov">Data</label>
          <input id="dataMov" type="date" />
        </div>
        <div id="boxFunc" class="hide">
          <label for="funcionarioSel">Funcionário</label>
          <select id="funcionarioSel"></select>
        </div>
      </div>

      <div class="grid2">
        <div id="boxEstado" class="hide">
          <label for="estadoItem">Estado (devolução)</label>
          <select id="estadoItem">
            <option value="EM_CONDICOES">Em condições</option>
            <option value="SEM_CONDICOES">Sem condições</option>
          </select>
        </div>
        <div id="boxMotivo" class="hide">
          <label for="motivoRuim">Motivo (obrigatório)</label>
          <input id="motivoRuim" type="text" />
        </div>
      </div>

      <div class="grid3">
        <div><label for="categoria">Categoria</label><select id="categoria"></select></div>
        <div><label for="tamanho">Tamanho</label><select id="tamanho"></select></div>
        <div><label for="quantidade">Quantidade</label><input id="quantidade" type="number" min="1" step="1" value="1" /></div>
      </div>

      <div id="boxObs" class="hide">
        <label for="obs">Observação</label>
        <input id="obs" type="text" />
      </div>

      <div class="btns">
        <button type="button" class="btn primary" id="btnSalvar">Salvar</button>
        <button type="button" class="btn" id="btnLimpar">Limpar</button>
      </div>

      <div class="sep no-print"></div>

      <div class="grid2 no-print">
        <div>
          <label for="relFuncSel">Relatório por funcionário</label>
          <select id="relFuncSel"></select>
        </div>
        <div class="btns" style="align-items:end; justify-content:flex-end;">
          <button type="button" class="btn" id="btnGerarRel">Gerar relatório</button>
          <button type="button" class="btn" id="btnLimparRel">Limpar relatório</button>
          <button type="button" class="btn primary" id="btnImprimirRel">Imprimir</button>
          <button type="button" class="btn primary" id="btnImprimirTermoDia" disabled>Imprimir termo do dia</button>
        </div>
      </div>

      <div id="printArea" class="card" style="margin-top:12px; display:none;">
        <div class="hd" id="printHeader"><div><h2>Relatório</h2><p>—</p></div></div>
        <div class="bd" id="printBody">
          <div class="tableWrap" style="max-height:none;">
            <table id="tblRelFunc">
              <thead><tr><th>Data</th><th>Tipo</th><th>Item</th><th>Tam.</th><th class="right">Qtd</th><th>Estado</th><th>Motivo</th><th>Obs.</th></tr></thead>
              <tbody><tr><td colspan="8" class="note">—</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <h2 style="margin-top:14px;">Histórico</h2>
      <div class="tableWrap">
        <table id="tblHistorico">
          <thead>
            <tr>
              <th>Data</th><th>Tipo</th><th>Funcionário</th><th>Item</th><th>Tam.</th>
              <th class="right">Qtd</th><th>Estado</th><th>Motivo</th><th>Obs.</th>
              <th class="no-print">Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </section>

  <section id="screen-func" class="card hide">
    <div class="hd"><div><h2>Funcionários</h2><p>Cadastro.</p></div></div>
    <div class="bd">
      <label for="novoNome">Novo funcionário</label>
      <input id="novoNome" type="text" />
      <div class="btns">
        <button type="button" class="btn primary" id="btnAddFunc">Adicionar</button>
      </div>
    </div>
  </section>

  <section id="screen-est" class="card hide">
    <div class="hd">
      <div><h2>Estoque</h2><p>Saldos atuais por item e tamanho.</p></div>
      <div class="chip"><span class="dot ok"></span><span id="pillTotal2">Total: —</span></div>
    </div>
    <div class="bd">
      <div class="tableWrap" style="max-height:520px;">
        <table id="tblEstoque">
          <thead><tr><th>Item</th><th>Tamanho</th><th class="right">Saldo</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="screen-cfg" class="card hide devOnlyScreen">
    <div class="hd"><div><h2>Config (DEV)</h2><p>Somente DEV.</p></div></div>
    <div class="bd">
      <label>URL do Web App (/exec)</label>
      <input id="cfgUrl" type="text" readonly />
      <p class="note">Se o login funcionar, esta URL já está correta.</p>
    </div>
  </section>

  <section id="screen-log" class="card hide devOnlyScreen">
    <div class="hd"><div><h2>Acessos (DEV)</h2><p>Usuários no Sheets.</p></div></div>
    <div class="bd">
      <label for="devPin">PIN do DEV (para gerenciar usuários)</label>
      <input id="devPin" type="password" inputmode="numeric" placeholder="6 dígitos (ex.: 200585)" autocomplete="off" />
      <div class="btns">
        <button type="button" class="btn" id="btnLoadUsers">Carregar usuários</button>
      </div>

      <div class="sep"></div>

      <div class="grid3">
        <div><label for="newUserLogin">Novo login</label><input id="newUserLogin" type="text" placeholder="ex.: maria" /></div>
        <div><label for="newUserName">Nome (opcional)</label><input id="newUserName" type="text" placeholder="ex.: Maria Silva" /></div>
        <div><label for="newUserPin">Senha (6 dígitos)</label><input id="newUserPin" type="password" inputmode="numeric" placeholder="ex.: 123456" /></div>
      </div>
      <div class="btns"><button type="button" class="btn primary" id="btnCreateUser">Criar usuário</button></div>

      <div class="sep"></div>

      <div class="tableWrap" style="max-height:420px;">
        <table id="tblUsers">
          <thead><tr><th>Login</th><th>Nome</th><th>Status</th><th class="right">Ações</th></tr></thead>
          <tbody><tr><td colspan="4" class="note">Carregue os usuários.</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
  const SHEETS_URL = "https://script.google.com/macros/s/AKfycbzef2t-ivoNG_Hu5ACUby0VStJ4ald49HU6W-2sL2ixDKfJZpEz3cfvw5PKAKeLP-lkzQ/exec";
  const DEV_EMAIL = "dayerre@gmail.com";
  const TERMO_LOCAL = "Colatina/ES";

  const DB_KEY="uniformes_db_site";
  const SESSION_KEY="uniformes_session_sheet_v3_jsonp";

  const CATALOG=[
    { categoria:"Camisa masculina manga longa", tamanhos:["P","M","G","GG","XG"] },
    { categoria:"Camisa masculina manga curta", tamanhos:["P","M","G","GG","XG"] },
    { categoria:"Calça brim c/ faixa refletiva (masc.)", tamanhos:["P","M","G","GG","XXG"] },
    { categoria:"Camisa feminina babylook", tamanhos:["P","M","G","GG","XXG"] },
  ];

  function todayISO(){ const d=new Date(); const pad=n=>String(n).padStart(2,"0"); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function formatBRDateFromISO(iso){ if(!iso||typeof iso!=="string"||iso.length<10) return ""; const [y,m,d]=iso.slice(0,10).split("-"); return `${d}/${m}/${y}`; }
  function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
  function makeId(){ try{ if(crypto?.randomUUID) return crypto.randomUUID(); }catch{} return String(Date.now())+"_"+Math.random().toString(16).slice(2); }
  function keyItem(c,t){ return `${c}__${t}`; }

  function loadDB(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)) ?? {movimentos:[],estoque:{},funcionarios:[]}; }catch{ return {movimentos:[],estoque:{},funcionarios:[]}; } }
  function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
  function getFuncById(db,id){ return db.funcionarios.find(f=>f.id===id)||null; }

  function loadSession(){ try{ return JSON.parse(localStorage.getItem(SESSION_KEY))||null; }catch{ return null; } }
  function saveSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
  function clearSession(){ localStorage.removeItem(SESSION_KEY); }
  function getCurrentUser(){ const s=loadSession(); if(!s||!s.login) return null; return s; }
  function isDevSession(){ const s=getCurrentUser(); return !!(s && s.isDev); }

  function setSheetsStatus(mode, msg){
    const dot=document.getElementById("dotSheets");
    const txt=document.getElementById("txtSheets");
    dot.classList.remove("ok","err","warn");
    dot.classList.add(mode==="ok" ? "ok" : mode==="erro" ? "err" : "warn");
    txt.textContent=msg;
  }

  // JSONP
  function apiJsonp(params, timeoutMs=12000){
    return new Promise((resolve, reject)=>{
      const cbName = "cb_" + Math.random().toString(16).slice(2);
      const u = new URL(SHEETS_URL);
      Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
      u.searchParams.set("callback", cbName);
      u.searchParams.set("_ts", String(Date.now()));

      const s = document.createElement("script");
      let done=false;

      window[cbName] = (data)=>{
        if(done) return;
        done=true;
        cleanup();
        resolve(data);
      };

      const t=setTimeout(()=>{
        if(done) return;
        done=true;
        cleanup();
        reject(new Error("Timeout ao comunicar com o Sheets."));
      }, timeoutMs);

      function cleanup(){
        clearTimeout(t);
        try{ delete window[cbName]; }catch{ window[cbName]=undefined; }
        s.remove();
      }

      s.onerror=()=>{
        if(done) return;
        done=true;
        cleanup();
        reject(new Error("Falha ao carregar resposta do servidor."));
      };

      s.src = u.toString();
      document.head.appendChild(s);
    });
  }

  async function api(params){
    const j = await apiJsonp(params);
    if(!j || typeof j !== "object") throw new Error("Resposta inválida do servidor.");
    if(!j.ok) throw new Error(j.error || "Erro.");
    return j;
  }

  // Login UI
  const loginOverlay=document.getElementById("loginOverlay");
  const loginUser=document.getElementById("loginUser");
  const loginPass=document.getElementById("loginPass");
  const btnLogin=document.getElementById("btnLogin");
  const loginErr=document.getElementById("loginErr");
  const txtUser=document.getElementById("txtUser");
  const btnLogout=document.getElementById("btnLogout");

  function showLogin(){
    loginErr.style.display="none"; loginErr.textContent="";
    loginOverlay.style.display="flex";
    setTimeout(()=>loginUser.focus(), 50);
  }
  function hideLogin(){ loginOverlay.style.display="none"; }
  function refreshUserChip(){
    const s=getCurrentUser();
    txtUser.textContent = s ? `Logado: ${s.login}${s.isDev ? " (DEV)" : ""}` : "Não logado";
  }
  function applyDevVisibility(){
    const isDev=isDevSession();
    document.querySelectorAll(".devOnly").forEach(el=>el.classList.toggle("hide", !isDev));
    document.querySelectorAll(".devOnlyScreen").forEach(el=>el.classList.toggle("hide", !isDev));
    if(!isDev){
      if(!document.getElementById("screen-cfg").classList.contains("hide") ||
         !document.getElementById("screen-log").classList.contains("hide")){
        setScreen("mov");
      }
    }
  }

  async function doLogin(){
    const login=String(loginUser.value||"").trim().toLowerCase();
    const pin=String(loginPass.value||"").trim();
    if(!login){ loginErr.textContent="Informe o usuário."; loginErr.style.display="block"; return; }
    if(!/^\d{6}$/.test(pin)){ loginErr.textContent="Senha inválida (6 dígitos)."; loginErr.style.display="block"; return; }

    try{
      setSheetsStatus("warn","Sheets: validando login...");
      const j = await api({ action:"login", login, pin });

      saveSession({ login: j.login, isDev: !!j.isDev, at: new Date().toLocaleString("pt-BR") });

      hideLogin();
      refreshUserChip();
      applyDevVisibility();
      setSheetsStatus("ok","Sheets: conectado");
    }catch(err){
      setSheetsStatus("erro","Sheets: erro");
      loginErr.textContent=String(err.message||err);
      loginErr.style.display="block";
    }
  }

  btnLogin.addEventListener("click", doLogin);
  loginPass.addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });
  loginUser.addEventListener("keydown", e=>{ if(e.key==="Enter") loginPass.focus(); });

  btnLogout.addEventListener("click", ()=>{
    clearSession();
    refreshUserChip();
    applyDevVisibility();
    showLogin();
  });

  // nav
  const navBtns=[...document.querySelectorAll(".navBtn")];
  const screens={
    mov:document.getElementById("screen-mov"),
    func:document.getElementById("screen-func"),
    est:document.getElementById("screen-est"),
    cfg:document.getElementById("screen-cfg"),
    log:document.getElementById("screen-log")
  };
  function setScreen(name){
    Object.entries(screens).forEach(([k,el])=>el.classList.toggle("hide", k!==name));
    navBtns.forEach(b=>b.classList.toggle("active", b.dataset.screen===name));
    if(name==="mov") renderMov();
    if(name==="func") renderFuncionariosSelect();
    if(name==="est") renderEstoque();
    if(name==="cfg") document.getElementById("cfgUrl").value=SHEETS_URL;
  }
  navBtns.forEach(b=>b.addEventListener("click",()=>setScreen(b.dataset.screen)));

  // refs
  const elTipo=document.getElementById("tipoMov");
  const elData=document.getElementById("dataMov");
  const boxFunc=document.getElementById("boxFunc");
  const elFuncSel=document.getElementById("funcionarioSel");
  const boxEstado=document.getElementById("boxEstado");
  const elEstado=document.getElementById("estadoItem");
  const boxMotivo=document.getElementById("boxMotivo");
  const elMotivo=document.getElementById("motivoRuim");
  const elCat=document.getElementById("categoria");
  const elTam=document.getElementById("tamanho");
  const elQtd=document.getElementById("quantidade");
  const boxObs=document.getElementById("boxObs");
  const elObs=document.getElementById("obs");
  const btnSalvar=document.getElementById("btnSalvar");
  const btnLimpar=document.getElementById("btnLimpar");
  const tblHistBody=document.querySelector("#tblHistorico tbody");
  const tblEstoqueBody=document.querySelector("#tblEstoque tbody");
  const pillTotal=document.getElementById("pillTotal");
  const pillTotal2=document.getElementById("pillTotal2");

  const relFuncSel=document.getElementById("relFuncSel");
  const btnGerarRel=document.getElementById("btnGerarRel");
  const btnLimparRel=document.getElementById("btnLimparRel");
  const btnImprimirRel=document.getElementById("btnImprimirRel");
  const btnImprimirTermoDia=document.getElementById("btnImprimirTermoDia");

  const printArea=document.getElementById("printArea");
  const printHeader=document.getElementById("printHeader");
  const printBody=document.getElementById("printBody");

  const elNovoNome=document.getElementById("novoNome");
  const btnAddFunc=document.getElementById("btnAddFunc");

  // DEV users UI
  const devPin=document.getElementById("devPin");
  const btnLoadUsers=document.getElementById("btnLoadUsers");
  const newUserLogin=document.getElementById("newUserLogin");
  const newUserName=document.getElementById("newUserName");
  const newUserPin=document.getElementById("newUserPin");
  const btnCreateUser=document.getElementById("btnCreateUser");
  const tblUsersBody=document.querySelector("#tblUsers tbody");

  function requireLogin(){
    if(!getCurrentUser()){ showLogin(); return false; }
    return true;
  }
  function requireDev(){
    if(!requireLogin()) return false;
    if(!isDevSession()){ alert("Somente DEV."); return false; }
    if(!/^\d{6}$/.test(String(devPin.value||"").trim())){ alert("Informe o PIN do DEV (6 dígitos)."); return false; }
    return true;
  }

  async function loadUsersFromSheet(){
    if(!requireDev()) return;
    const s=getCurrentUser();
    try{
      const j=await api({ action:"listUsers", devLogin:s.login, devPin:String(devPin.value||"").trim() });
      renderUsersTable(j.users||[]);
    }catch(err){
      alert(String(err.message||err));
    }
  }

  function renderUsersTable(users){
    const sorted=[...users].sort((a,b)=>String(a.login).localeCompare(String(b.login)));
    tblUsersBody.innerHTML = sorted.map(u=>`
      <tr>
        <td>${escapeHtml(u.login)}</td>
        <td>${escapeHtml(u.name||"—")}</td>
        <td>${u.active ? "Ativo" : "Inativo"}</td>
        <td class="right">
          <button class="btn" type="button" onclick="toggleUserSheet('${escapeHtml(u.login)}')">${u.active ? "Desativar" : "Ativar"}</button>
          <button class="btn" type="button" onclick="resetPinSheet('${escapeHtml(u.login)}')">Reset senha</button>
          <button class="btn danger" type="button" onclick="removeUserSheet('${escapeHtml(u.login)}')">Remover</button>
        </td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="note">Sem usuários.</td></tr>`;
  }

  window.toggleUserSheet = async (login)=>{
    if(!requireDev()) return;
    const s=getCurrentUser();
    await api({ action:"toggleUser", login, devLogin:s.login, devPin:String(devPin.value||"").trim() });
    loadUsersFromSheet();
  };
  window.resetPinSheet = async (login)=>{
    if(!requireDev()) return;
    const np=prompt("Nova senha (6 dígitos):");
    if(np===null) return;
    if(!/^\d{6}$/.test(np)) return alert("Precisa ser 6 dígitos.");
    const s=getCurrentUser();
    await api({ action:"resetPin", login, pin:np, devLogin:s.login, devPin:String(devPin.value||"").trim() });
    loadUsersFromSheet();
  };
  window.removeUserSheet = async (login)=>{
    if(!requireDev()) return;
    if(!confirm("Remover usuário?")) return;
    const s=getCurrentUser();
    await api({ action:"removeUser", login, devLogin:s.login, devPin:String(devPin.value||"").trim() });
    loadUsersFromSheet();
  };

  btnLoadUsers.addEventListener("click", loadUsersFromSheet);
  btnCreateUser.addEventListener("click", async ()=>{
    if(!requireDev()) return;
    const login=String(newUserLogin.value||"").trim().toLowerCase();
    const name=String(newUserName.value||"").trim();
    const pin=String(newUserPin.value||"").trim();
    if(!login) return alert("Informe o login.");
    if(login===DEV_EMAIL.toLowerCase()) return alert("Login reservado ao DEV.");
    if(!/^\d{6}$/.test(pin)) return alert("Senha deve ter 6 dígitos.");

    const s=getCurrentUser();
    await api({ action:"createUser", login, name, pin, devLogin:s.login, devPin:String(devPin.value||"").trim() });

    newUserLogin.value=""; newUserName.value=""; newUserPin.value="";
    loadUsersFromSheet();
  });

  // Local + catálogo
  function upsertEstoque(db,c,t,delta){ const k=keyItem(c,t); db.estoque[k]=Number(db.estoque[k]??0)+delta; }
  function fillCategorias(){ elCat.innerHTML=CATALOG.map(c=>`<option value="${escapeHtml(c.categoria)}">${escapeHtml(c.categoria)}</option>`).join(""); }
  function fillTamanhos(){ const found=CATALOG.find(x=>x.categoria===elCat.value); const ts=found?found.tamanhos:[]; elTam.innerHTML=ts.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join(""); }
  function fillRelFuncionarios(){
    const db=loadDB();
    const todos=db.funcionarios.slice().sort((a,b)=>a.nome.localeCompare(b.nome));
    relFuncSel.innerHTML=[`<option value="">(Selecione)</option>`].concat(
      todos.map(f=>`<option value="${escapeHtml(f.id)}">${escapeHtml(f.nome + (f.ativo ? "" : " [inativo]"))}</option>`)
    ).join("");
  }
  function renderFuncionariosSelect(){
    const db=loadDB();
    const ativos=db.funcionarios.filter(f=>f.ativo).sort((a,b)=>a.nome.localeCompare(b.nome));
    elFuncSel.innerHTML=[`<option value="">(Selecione)</option>`].concat(
      ativos.map(f=>`<option value="${escapeHtml(f.id)}">${escapeHtml(f.nome)}</option>`)
    ).join("");
    fillRelFuncionarios();
  }
  function updateMovUI(){
    const tipo=elTipo.value;
    const precisa=(tipo==="SAIDA"||tipo==="DEVOLUCAO");
    const isDev=(tipo==="DEVOLUCAO");
    const isSem=isDev && (elEstado.value==="SEM_CONDICOES");
    boxFunc.classList.toggle("hide", !precisa);
    boxEstado.classList.toggle("hide", !isDev);
    boxMotivo.classList.toggle("hide", !isSem);
    boxObs.classList.toggle("hide", !isDev);
    if(!isDev) elObs.value="";
    if(!precisa) elFuncSel.value="";
    if(!isSem) elMotivo.value="";
  }
  function tipoLabel(t){ return t==="SAIDA" ? "SAÍDA" : (t==="DEVOLUCAO" ? "DEVOLUÇÃO" : t); }
  function estadoLabel(e){ if(!e) return "—"; if(e==="EM_CONDICOES") return "Em condições"; if(e==="SEM_CONDICOES") return "Sem condições"; return e; }

  function renderEstoque(){
    const db=loadDB();
    let total=0;
    const rows=[];
    Object.entries(db.estoque).map(([k,v])=>{
      const [c,t]=k.split("__");
      return {c,t,s:Number(v)};
    }).sort((a,b)=>(a.c+a.t).localeCompare(b.c+b.t)).forEach(it=>{
      total += it.s;
      rows.push(`<tr><td>${escapeHtml(it.c)}</td><td>${escapeHtml(it.t)}</td><td class="right">${it.s}</td></tr>`);
    });
    tblEstoqueBody.innerHTML = rows.join("") || `<tr><td colspan="3" class="note">Sem itens.</td></tr>`;
    pillTotal.textContent = `Estoque: ${total} peça(s)`;
    pillTotal2.textContent = `Total: ${total} peça(s)`;
  }

  function renderMov(){
    renderFuncionariosSelect();
    renderEstoque();
    const db=loadDB();
    const hist=[...db.movimentos].filter(m=>!m.hidden).reverse().slice(0,250);
    tblHistBody.innerHTML = hist.map(m=>{
      const f=m.funcionarioId?getFuncById(db,m.funcionarioId):null;
      return `<tr>
        <td>${escapeHtml(m.data)}</td>
        <td>${escapeHtml(tipoLabel(m.tipo))}</td>
        <td>${escapeHtml(f?f.nome:"—")}</td>
        <td>${escapeHtml(m.categoria)}</td>
        <td>${escapeHtml(m.tamanho)}</td>
        <td class="right">${Number(m.quantidade)}</td>
        <td>${escapeHtml(estadoLabel(m.estado))}</td>
        <td>${escapeHtml(m.motivo||"—")}</td>
        <td>${escapeHtml(m.obs||"")}</td>
        <td class="no-print"><button type="button" class="btn danger" onclick="hideMovimento('${escapeHtml(m.id)}')">Excluir</button></td>
      </tr>`;
    }).join("") || `<tr><td colspan="10" class="note">Sem movimentações.</td></tr>`;
  }

  // ====== IMPORTANTE: Carregar do Sheets (snapshot)
  document.getElementById("btnCarregarSheetsUrl").addEventListener("click", async ()=>{
    if(!requireLogin()) return;
    try{
      setSheetsStatus("warn","Sheets: carregando...");
      const j = await api({ action:"getSnapshot" });

      const db = loadDB();
      db.funcionarios = Array.isArray(j.funcionarios) ? j.funcionarios : [];
      db.movimentos  = Array.isArray(j.movimentos) ? j.movimentos : [];
      db.estoque = {};

      for(const m of db.movimentos){
        const qtd = Number(m.quantidade||0);
        if(!qtd) continue;

        let delta=0;
        if(m.tipo==="ENTRADA") delta=qtd;
        if(m.tipo==="SAIDA") delta=-qtd;
        if(m.tipo==="DEVOLUCAO") delta=(m.estado==="EM_CONDICOES") ? qtd : 0;

        if(delta!==0){
          const k = `${m.categoria}__${m.tamanho}`;
          db.estoque[k] = Number(db.estoque[k]||0) + delta;
        }
      }

      saveDB(db);
      renderMov();
      renderEstoque();
      setSheetsStatus("ok","Sheets: sincronizado");
      alert("Dados carregados do Sheets.");
    }catch(err){
      setSheetsStatus("erro","Sheets: erro");
      alert(String(err.message||err));
    }
  });

  // manter: salvar local (não manda ao Sheets aqui; se você quiser, eu ligo depois)
  btnSalvar.addEventListener("click", ()=>{
    if(!requireLogin()) return;

    const db=loadDB();
    const tipo=elTipo.value;
    if(!elData.value) return alert("Informe a data.");
    const qtd=Number(elQtd.value);
    if(!Number.isFinite(qtd)||qtd<=0) return alert("Quantidade inválida.");
    if((tipo==="SAIDA"||tipo==="DEVOLUCAO") && !elFuncSel.value) return alert("Selecione o funcionário.");
    if(tipo==="DEVOLUCAO" && elEstado.value==="SEM_CONDICOES" && !elMotivo.value.trim()) return alert("Informe o motivo.");

    const mov={
      id:makeId(), tipo, data:elData.value,
      funcionarioId:(tipo==="SAIDA"||tipo==="DEVOLUCAO")?elFuncSel.value:"",
      categoria:elCat.value, tamanho:elTam.value,
      quantidade:qtd,
      estado:(tipo==="DEVOLUCAO")?elEstado.value:"",
      motivo:(tipo==="DEVOLUCAO" && elEstado.value==="SEM_CONDICOES")?elMotivo.value.trim():"",
      obs:(tipo==="DEVOLUCAO") ? elObs.value.trim() : "",
      hidden:false
    };

    let delta=0;
    if(tipo==="ENTRADA") delta=qtd;
    if(tipo==="SAIDA") delta=-qtd;
    if(tipo==="DEVOLUCAO") delta=(mov.estado==="EM_CONDICOES")?qtd:0;

    if(tipo==="SAIDA"){
      const k=keyItem(mov.categoria,mov.tamanho);
      const saldo=Number(db.estoque[k]??0);
      if(saldo+delta<0) return alert("Saldo insuficiente.");
    }

    if(delta!==0) upsertEstoque(db,mov.categoria,mov.tamanho,delta);
    db.movimentos.push(mov);
    saveDB(db);

    elObs.value=""; elQtd.value="1"; elMotivo.value="";
    updateMovUI(); renderMov();
  });

  btnLimpar.addEventListener("click", ()=>{
    elTipo.value="ENTRADA";
    elFuncSel.value="";
    elEstado.value="EM_CONDICOES";
    elQtd.value="1";
    elMotivo.value="";
    elObs.value="";
    elData.value=todayISO();
    fillTamanhos();
    updateMovUI();
  });

  btnAddFunc.addEventListener("click", ()=>{
    if(!requireLogin()) return;
    const nome=String(elNovoNome.value||"").trim();
    if(!nome) return alert("Informe o nome.");
    const db=loadDB();
    if(db.funcionarios.some(f=>f.nome.toLowerCase()===nome.toLowerCase())) return alert("Já existe.");
    db.funcionarios.push({ id:makeId(), nome, ativo:true });
    saveDB(db);
    elNovoNome.value="";
    renderFuncionariosSelect();
    alert("Funcionário cadastrado.");
  });

  function hideMovimento(id){
    if(!requireLogin()) return;
    if(!confirm("Ocultar este registro?")) return;
    const db=loadDB();
    const m=db.movimentos.find(x=>x.id===id);
    if(!m) return;
    m.hidden=true;
    saveDB(db);
    renderMov();
  }
  window.hideMovimento=hideMovimento;

  function boot(){
    fillCategorias(); fillTamanhos(); fillRelFuncionarios();
    elData.value=todayISO();
    updateMovUI();
    renderMov(); renderEstoque();
    setScreen("mov");
    document.getElementById("cfgUrl").value=SHEETS_URL;

    // Exigir login sempre
    clearSession();
    refreshUserChip();
    applyDevVisibility();
    showLogin();

    setSheetsStatus("warn","Sheets: verificando...");
    api({ action:"ping" })
      .then(()=>setSheetsStatus("ok","Sheets: conectado"))
      .catch(()=>setSheetsStatus("warn","Sheets: offline"));

    elTipo.addEventListener("change", updateMovUI);
    elEstado.addEventListener("change", updateMovUI);
    elCat.addEventListener("change", fillTamanhos);
  }
  boot();
</script>
</body>
</html>
